@page "/requests/new"
@page "/requests/{RequestId:guid}"
@rendermode InteractiveWebAssembly
@using KoruTechnicalAssignment.Web.Client.Models
@using System.Linq
@attribute [Authorize(Roles = "User")]
@attribute [StreamRendering]

@inject RequestApiClient ApiClient
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>Request Form</PageTitle>

<h1 class="mb-3">@PageTitleText</h1>

@if (!string.IsNullOrEmpty(formMessage))
{
    <div class="alert @(formSuccess ? "alert-success" : "alert-danger")">@formMessage</div>
}

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm EditContext="@editContext" OnValidSubmit="() => SaveAsync(false)">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Branch</label>
                <InputSelect class="form-select" @bind-Value="form.BranchId" disabled="@(!CanEdit)">
                    <option value="">Select branch</option>
                    @foreach (var branch in branches)
                    {
                        <option value="@branch.Id">@branch.Name (@branch.Location)</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-4">
                <label class="form-label">Request Date</label>
                <InputDate class="form-control" @bind-Value="form.RequestDate" disabled="@(!CanEdit)" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Start Time</label>
                <InputSelect class="form-select" @bind-Value="StartTimeText" disabled="@(!CanEdit)">
                    <option value="">Select time</option>
                    @foreach (var time in StartTimeOptions)
                    {
                        var value = time.ToString("HH\\:mm");
                        <option value="@value">@value</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-2">
                <label class="form-label">End Time</label>
                <InputSelect class="form-select" @bind-Value="EndTimeText" disabled="@(!CanEdit)">
                    <option value="">Select time</option>
                    @foreach (var time in EndTimeOptions)
                    {
                        var value = time.ToString("HH\\:mm");
                        <option value="@value">@value</option>
                    }
                </InputSelect>
            </div>
            <div class="col-12">
                <label class="form-label">Title</label>
                <InputText class="form-control" @bind-Value="form.Title" disabled="@(!CanEdit)" />
            </div>
            <div class="col-12">
                <label class="form-label">Description</label>
                <InputTextArea class="form-control" @bind-Value="form.Description" rows="4" disabled="@(!CanEdit)" />
            </div>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button class="btn btn-secondary" type="button" @onclick="Cancel">Back</button>
            @if (CanEdit)
            {
                <button class="btn btn-primary" type="submit" disabled="@isSaving">
                    @(isSaving ? "Saving..." : "Save Draft")
                </button>
                <button class="btn btn-success" type="button" disabled="@isSubmitting" @onclick="() => SaveAsync(true)">
                    @(isSubmitting ? "Submitting..." : "Submit")
                </button>
            }
            else
            {
                <span class="alert alert-info mb-0 py-2 px-3">Only draft requests can be edited.</span>
            }
        </div>
    </EditForm>
}

@code {
    [Parameter] public Guid? RequestId { get; set; }

    private readonly RequestFormModel form = new();
    private EditContext? editContext;
    private ValidationMessageStore? validationMessageStore;
    private IReadOnlyList<BranchModel> branches = Array.Empty<BranchModel>();

    private bool isLoading = true;
    private bool isSaving;
    private bool isSubmitting;
    private bool formSuccess;
    private string? formMessage;
    private Guid? currentRequestId;
    private RequestStatusModel? currentStatus;

    private string PageTitleText => currentRequestId.HasValue ? "Update Request" : "New Request";
    private bool CanEdit => !currentRequestId.HasValue || currentStatus == RequestStatusModel.Draft;

    private string? StartTimeText
    {
        get => form.StartTime?.ToString("HH\\:mm");
        set => form.StartTime = ParseTime(value, true);
    }

    private string? EndTimeText
    {
        get => form.EndTime?.ToString("HH\\:mm");
        set => form.EndTime = ParseTime(value, false);
    }

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(form);
        validationMessageStore = new ValidationMessageStore(editContext);
        editContext.OnValidationRequested += (_, _) => ApplyBusinessValidation();
        editContext.OnFieldChanged += (_, _) => ApplyBusinessValidation();

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            branches = await ApiClient.GetBranchesAsync();

            if (RequestId.HasValue)
            {
                var dto = await ApiClient.GetRequestForUserAsync(RequestId.Value);
                if (dto is not null)
                {
                    currentRequestId = dto.Id;
                    currentStatus = dto.Status;
                    form.BranchId = dto.BranchId;
                    form.Title = dto.Title;
                    form.Description = dto.Description;
                    form.RequestDate = dto.RequestDate;
                    form.StartTime = dto.StartTime;
                    form.EndTime = dto.EndTime;
                }
            }
        }
        catch (Exception ex)
        {
            formSuccess = false;
            formMessage = $"An error occurred while loading the form: {ex.Message}";
            NotificationService.Error(formMessage);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SaveAsync(bool submitAfterSave)
    {
        if (editContext is null || !editContext.Validate())
        {
            return;
        }

        if (!CanEdit)
        {
            formSuccess = false;
            formMessage = "Only draft requests can be updated.";
            NotificationService.Error(formMessage);
            return;
        }

        try
        {
            isSaving = true;

            if (!currentRequestId.HasValue)
            {
                var id = await ApiClient.CreateDraftAsync(form);
                if (id == Guid.Empty)
                {
                    throw new InvalidOperationException("Request could not be created.");
                }

                currentRequestId = id;
                currentStatus = RequestStatusModel.Draft;
                formMessage = "Draft created successfully.";
            }
            else
            {
                await ApiClient.UpdateDraftAsync(currentRequestId.Value, form);
                formMessage = "Draft updated.";
            }

            formSuccess = true;
            NotificationService.Success(formMessage!);

            if (submitAfterSave && currentRequestId.HasValue)
            {
                isSubmitting = true;
                await ApiClient.SubmitAsync(currentRequestId.Value);
                currentStatus = RequestStatusModel.Pending;
                formMessage = "Request submitted successfully.";
                NotificationService.Success(formMessage);
            }
        }
        catch (Exception ex)
        {
            formSuccess = false;
            formMessage = $"Operation could not be completed: {ex.Message}";
            NotificationService.Error(formMessage);
        }
        finally
        {
            isSaving = false;
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ApplyBusinessValidation()
    {
        if (editContext is null || validationMessageStore is null)
        {
            return;
        }

        validationMessageStore.Clear();

        if (form.RequestDate.HasValue && form.RequestDate.Value < DateOnly.FromDateTime(DateTime.Today))
        {
            validationMessageStore.Add(new FieldIdentifier(form, nameof(form.RequestDate)), "Request date cannot be earlier than today.");
        }

        if (form.StartTime.HasValue && form.EndTime.HasValue && form.EndTime <= form.StartTime)
        {
            validationMessageStore.Add(new FieldIdentifier(form, nameof(form.EndTime)), "End time must be after start time.");
        }

        editContext.NotifyValidationStateChanged();
    }

    private void Cancel() => NavigationManager.NavigateTo("my-requests");

    private static readonly IReadOnlyList<TimeOnly> StartTimeOptions = BuildSlots(new TimeOnly(9, 0), new TimeOnly(12, 30))
        .Concat(BuildSlots(new TimeOnly(14, 0), new TimeOnly(17, 30))).ToList();

    private static readonly IReadOnlyList<TimeOnly> EndTimeOptions = BuildSlots(new TimeOnly(9, 30), new TimeOnly(13, 0))
        .Concat(BuildSlots(new TimeOnly(14, 30), new TimeOnly(18, 0))).ToList();

    private static TimeOnly? ParseTime(string? value, bool isStart)
    {
        if (!TimeOnly.TryParse(value, out var time))
        {
            return null;
        }

        var allowed = isStart ? StartTimeOptions : EndTimeOptions;
        return allowed.Contains(time) ? time : null;
    }

    private static IEnumerable<TimeOnly> BuildSlots(TimeOnly start, TimeOnly end)
    {
        for (var slot = start; slot <= end; slot = slot.AddMinutes(30))
        {
            yield return slot;
        }
    }
}
