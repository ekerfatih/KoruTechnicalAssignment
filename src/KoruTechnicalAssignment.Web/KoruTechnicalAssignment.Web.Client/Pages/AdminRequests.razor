@page "/admin/requests"
@rendermode InteractiveWebAssembly
@using KoruTechnicalAssignment.Web.Client.Models
@attribute [Authorize(Roles = "Admin")]
@attribute [StreamRendering]

@inject RequestApiClient ApiClient
@inject NotificationService NotificationService

<PageTitle>Admin Requests</PageTitle>

<h1 class="mb-4">All Requests</h1>

<div class="row g-3 mb-3">
    <div class="col-md-2">
        <label class="form-label">Status</label>
        <select class="form-select" value="@((int)filters.Status)" @onchange="OnStatusChanged">
            @foreach (RequestStatusFilterOption option in Enum.GetValues<RequestStatusFilterOption>())
            {
                <option value="@((int)option)">@RequestStatusDisplay.GetFilterText(option)</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control" value="@FormatDate(filters.StartDate)" @onchange="OnStartDateChanged" />
    </div>
    <div class="col-md-2">
        <label class="form-label">End Date</label>
        <input type="date" class="form-control" value="@FormatDate(filters.EndDate)" @onchange="OnEndDateChanged" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Sort By</label>
        <select class="form-select" value="@((int)filters.SortBy)" @onchange="OnSortFieldChanged">
            @foreach (RequestSortField option in Enum.GetValues<RequestSortField>())
            {
                <option value="@((int)option)">@GetSortLabel(option)</option>
            }
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Search</label>
        <input class="form-control"
               value="@(filters.Search ?? string.Empty)"
               @oninput="OnSearchChanged"
               placeholder="Title or requester" />
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-secondary" type="button" @onclick="ResetFilters" disabled="@isLoading">Reset</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (requests.Total == 0)
{
    <div class="alert alert-info">No records found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Request #</th>
                    <th>Title</th>
                    <th>Requester</th>
                    <th>Date</th>
                    <th>
                        <button class="btn btn-link p-0 text-decoration-none d-inline-flex align-items-center gap-1"
                                type="button"
                                @onclick="ToggleStatusSortAsync">
                            Status
                            <span class="fw-bold @(filters.SortBy == RequestSortField.Status ? string.Empty : "text-muted")">
                                @(filters.SortDirection == SortDirection.Asc ? "↑" : "↓")
                            </span>
                        </button>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in requests.Items)
                {
                    <tr>
                        <td>@item.Id.ToString()[..8]</td>
                        <td>@item.Title</td>
                        <td>@item.RequesterName</td>
                        <td>@item.RequestDate.ToString("dd.MM.yyyy")</td>
                        <td>
                            <span class="@RequestStatusDisplay.GetBadgeClass(item.Status)">
                                @RequestStatusDisplay.GetStatusText(item.Status)
                            </span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-2">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-success"
                                            disabled="@(processingRequestId == item.Id)"
                                            @onclick="() => ApproveAsync(item.Id)">
                                        @(processingRequestId == item.Id ? "Approving..." : "Approve")
                                    </button>
                                    <button class="btn btn-outline-secondary" @onclick="() => LoadDetailsAsync(item.Id)">
                                        Details
                                    </button>
                                </div>
                                <div class="input-group input-group-sm">
                                    <input class="form-control"
                                           placeholder="Rejection note"
                                           value="@GetRejectReason(item.Id)"
                                           @oninput="(ChangeEventArgs e) => SetRejectReason(item.Id, e.Value?.ToString() ?? string.Empty)" />
                                    <button class="btn btn-danger"
                                            disabled="@(processingRequestId == item.Id)"
                                            @onclick="() => RejectAsync(item.Id)">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <p class="mb-0">Total @requests.Total item(s)</p>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="() => ChangePage(filters.Page - 1)" disabled="@(filters.Page <= 1 || isLoading)">Previous</button>
            <button class="btn btn-outline-secondary" disabled>@filters.Page</button>
            <button class="btn btn-outline-secondary" @onclick="() => ChangePage(filters.Page + 1)" disabled="@IsLastPage">Next</button>
        </div>
    </div>
}

<RequestHistoryModal IsVisible="@isHistoryModalOpen"
                     Request="selectedRequest"
                     OnClose="CloseHistoryModal" />

@code {
    private readonly RequestFiltersModel filters = new() { SortBy = RequestSortField.Status, SortDirection = SortDirection.Asc };
    private readonly Dictionary<Guid, string> rejectReasons = new();
    private RequestListResponse requests = new();
    private bool isLoading = true;
    private string? errorMessage;
    private Guid? processingRequestId;
    private RequestDetailModel? selectedRequest;
    private bool isHistoryModalOpen;

    private bool IsLastPage => filters.Page * filters.PageSize >= requests.Total;

    protected override async Task OnInitializedAsync()
    {
        if (OperatingSystem.IsBrowser())
        {
            await ReloadAsync();
        }
    }

    private async Task ReloadAsync(int? page = null)
    {
        if (page.HasValue)
        {
            filters.Page = Math.Max(1, page.Value);
        }

        try
        {
            errorMessage = null;
            isLoading = true;
            requests = await ApiClient.GetAdminRequestsAsync(filters);
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to load requests: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private Task ChangePage(int newPage)
    {
        if (newPage <= 0 || newPage == filters.Page)
        {
            return Task.CompletedTask;
        }

        return ReloadAsync(newPage);
    }

    private async Task ApproveAsync(Guid id)
    {
        try
        {
            processingRequestId = id;
            await ApiClient.ApproveAsync(id, null);
            NotificationService.Success("Request approved.");
            await ReloadAsync(filters.Page);
        }
        catch (Exception ex)
        {
            errorMessage = $"Request could not be approved: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            processingRequestId = null;
        }
    }

    private async Task RejectAsync(Guid id)
    {
        var reason = GetRejectReason(id);
        if (string.IsNullOrWhiteSpace(reason))
        {
            errorMessage = "Please enter a reason to reject the request.";
            NotificationService.Error(errorMessage);
            return;
        }

        try
        {
            processingRequestId = id;
            await ApiClient.RejectAsync(id, reason);
            NotificationService.Success("Request rejected.");
            rejectReasons[id] = string.Empty;
            await ReloadAsync(filters.Page);
        }
        catch (Exception ex)
        {
            errorMessage = $"Request could not be rejected: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            processingRequestId = null;
        }
    }

    private async Task LoadDetailsAsync(Guid id)
    {
        try
        {
            selectedRequest = await ApiClient.GetRequestForAdminAsync(id);
            isHistoryModalOpen = selectedRequest is not null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to load details: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
    }

    private Task CloseHistoryModal()
    {
        isHistoryModalOpen = false;
        selectedRequest = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private string GetRejectReason(Guid id) =>
        rejectReasons.TryGetValue(id, out var value) ? value : string.Empty;

    private void SetRejectReason(Guid id, string value) => rejectReasons[id] = value;

    private async Task ResetFilters()
    {
        filters.Status = RequestStatusFilterOption.All;
        filters.StartDate = null;
        filters.EndDate = null;
        filters.Search = null;
        filters.Page = 1;
        filters.SortBy = RequestSortField.Status;
        filters.SortDirection = SortDirection.Asc;
        await ReloadAsync();
    }

    private async Task TriggerFilterAsync()
    {
        filters.Page = 1;
        await ReloadAsync();
    }

    private async Task OnStartDateChanged(ChangeEventArgs args)
    {
        filters.StartDate = ParseDate(args.Value?.ToString());
        await TriggerFilterAsync();
    }

    private async Task OnEndDateChanged(ChangeEventArgs args)
    {
        filters.EndDate = ParseDate(args.Value?.ToString());
        await TriggerFilterAsync();
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        var text = args.Value?.ToString();
        filters.Search = string.IsNullOrWhiteSpace(text) ? null : text;
        await TriggerFilterAsync();
    }

    private async Task OnSortFieldChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var value))
        {
            filters.SortBy = (RequestSortField)value;
            await TriggerFilterAsync();
        }
    }

    private async Task OnStatusChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var value))
        {
            filters.Status = (RequestStatusFilterOption)value;
        }
        await TriggerFilterAsync();
    }

    private async Task ToggleStatusSortAsync()
    {
        filters.SortBy = RequestSortField.Status;
        filters.SortDirection = filters.SortDirection == SortDirection.Asc
            ? SortDirection.Desc
            : SortDirection.Asc;
        await TriggerFilterAsync();
    }

    private static string GetSortLabel(RequestSortField field) =>
        field switch
        {
            RequestSortField.Status => "Status",
            _ => "Date"
        };

    private static string? FormatDate(DateOnly? date) => date?.ToString("yyyy-MM-dd");

    private static DateOnly? ParseDate(string? raw) =>
        DateOnly.TryParse(raw, out var value) ? value : null;
}
