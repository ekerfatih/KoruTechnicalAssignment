@page "/my-requests"
@rendermode InteractiveWebAssembly
@using KoruTechnicalAssignment.Web.Client.Models
@attribute [Authorize(Roles = "User")]
@attribute [StreamRendering]

@inject RequestApiClient ApiClient
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<PageTitle>My Requests</PageTitle>

<h1 class="mb-4">My Requests</h1>

<div class="row g-3 mb-3">
    <div class="col-md-2">
        <label class="form-label">Status</label>
        <select class="form-select" value="@((int)filters.Status)" @onchange="OnStatusChanged">
            @foreach (RequestStatusFilterOption option in Enum.GetValues<RequestStatusFilterOption>())
            {
                <option value="@((int)option)">@RequestStatusDisplay.GetFilterText(option)</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control" value="@FormatDate(filters.StartDate)" @onchange="OnStartDateChanged" />
    </div>
    <div class="col-md-2">
        <label class="form-label">End Date</label>
        <input type="date" class="form-control" value="@FormatDate(filters.EndDate)" @onchange="OnEndDateChanged" />
    </div>
    <div class="col-md-2">
        <label class="form-label">Sort By</label>
        <select class="form-select" value="@((int)filters.SortBy)" @onchange="OnSortFieldChanged">
            @foreach (RequestSortField option in Enum.GetValues<RequestSortField>())
            {
                <option value="@((int)option)">@GetSortLabel(option)</option>
            }
        </select>
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-outline-secondary w-100" type="button" @onclick="ToggleSortDirection">
            @(filters.SortDirection == SortDirection.Asc ? "Ascending" : "Descending")
        </button>
    </div>
    <div class="col-md-2">
        <label class="form-label">Search</label>
        <input class="form-control"
               value="@(filters.Search ?? string.Empty)"
               @oninput="OnSearchChanged"
               placeholder="Title or branch" />
    </div>
    <div class="col-md-3 d-flex align-items-end gap-2">
        <button class="btn btn-secondary" type="button" @onclick="ResetFilters" disabled="@isLoading">Reset</button>
        <button class="btn btn-success" type="button" @onclick="NavigateToNew">New Request</button>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (requests.Total == 0)
{
    <div class="alert alert-info">No requests match the selected filters.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>Request #</th>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in requests.Items)
                {
                    <tr>
                        <td>@item.Id.ToString()[..8]</td>
                        <td>@item.Title</td>
                        <td>@item.RequestDate.ToString("dd.MM.yyyy")</td>
                        <td>@item.StartTime.ToString("HH\\:mm")</td>
                        <td>
                            <span class="@RequestStatusDisplay.GetBadgeClass(item.Status)">
                                @RequestStatusDisplay.GetStatusText(item.Status)
                            </span>
                        </td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-link" @onclick="() => ShowDetailsAsync(item.Id)">Details</button>
                                <button class="btn btn-link" @onclick="() => EditRequest(item.Id)">Edit</button>
                                @if (item.Status == RequestStatusModel.Draft)
                                {
                                    <button class="btn btn-primary"
                                            disabled="@(pendingSubmitId == item.Id)"
                                            @onclick="() => SubmitAsync(item.Id)">
                                        @(pendingSubmitId == item.Id ? "Submitting..." : "Submit")
                                    </button>
                                }
                                else if (item.Status == RequestStatusModel.Rejected)
                                {
                                    <button class="btn btn-warning"
                                            disabled="@(reopeningRequestId == item.Id)"
                                            @onclick="() => ReopenAsync(item.Id)">
                                        @(reopeningRequestId == item.Id ? "Reopening..." : "Reopen")
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <p class="mb-0">Total @requests.Total item(s)</p>
        <div class="btn-group">
            <button class="btn btn-outline-secondary" @onclick="() => ChangePage(filters.Page - 1)" disabled="@(filters.Page <= 1 || isLoading)">Previous</button>
            <button class="btn btn-outline-secondary" disabled>@filters.Page</button>
            <button class="btn btn-outline-secondary" @onclick="() => ChangePage(filters.Page + 1)" disabled="@IsLastPage">Next</button>
        </div>
    </div>
}

<RequestHistoryModal IsVisible="@isHistoryModalOpen"
                     Request="selectedRequest"
                     OnClose="CloseHistoryModal" />

@code {
    private readonly RequestFiltersModel filters = new();
    private RequestListResponse requests = new();
    private bool isLoading = true;
    private string? errorMessage;
    private Guid? pendingSubmitId;
    private Guid? reopeningRequestId;
    private RequestDetailModel? selectedRequest;
    private bool isHistoryModalOpen;

    private bool IsLastPage => filters.Page * filters.PageSize >= requests.Total;

    protected override async Task OnInitializedAsync()
    {
        if (OperatingSystem.IsBrowser())
        {
            await ReloadAsync();
        }
    }

    private async Task ReloadAsync(int? page = null)
    {
        if (page.HasValue)
        {
            filters.Page = Math.Max(1, page.Value);
        }

        try
        {
            errorMessage = null;
            isLoading = true;
            requests = await ApiClient.GetMyRequestsAsync(filters);
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to load requests: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SubmitAsync(Guid requestId)
    {
        try
        {
            pendingSubmitId = requestId;
            await ApiClient.SubmitAsync(requestId);
            await ReloadAsync(filters.Page);
            NotificationService.Success("Request submitted.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Request could not be submitted: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            pendingSubmitId = null;
        }
    }

    private async Task ReopenAsync(Guid requestId)
    {
        try
        {
            reopeningRequestId = requestId;
            await ApiClient.ReopenAsync(requestId);
            await ReloadAsync(filters.Page);
            NotificationService.Success("Request reopened as draft.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Request could not be reopened: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
        finally
        {
            reopeningRequestId = null;
        }
    }

    private void EditRequest(Guid id) => NavigationManager.NavigateTo($"requests/{id}");

    private void NavigateToNew() => NavigationManager.NavigateTo("requests/new");

    private async Task ResetFilters()
    {
        filters.Status = RequestStatusFilterOption.All;
        filters.Search = null;
        filters.StartDate = null;
        filters.EndDate = null;
        filters.Page = 1;
        filters.SortBy = RequestSortField.Date;
        filters.SortDirection = SortDirection.Desc;
        await ReloadAsync();
    }

    private async Task TriggerFilterAsync()
    {
        filters.Page = 1;
        await ReloadAsync();
    }

    private async Task OnStatusChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var value))
        {
            filters.Status = (RequestStatusFilterOption)value;
        }
        await TriggerFilterAsync();
    }

    private async Task OnStartDateChanged(ChangeEventArgs args)
    {
        filters.StartDate = ParseDate(args.Value?.ToString());
        await TriggerFilterAsync();
    }

    private async Task OnEndDateChanged(ChangeEventArgs args)
    {
        filters.EndDate = ParseDate(args.Value?.ToString());
        await TriggerFilterAsync();
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        var text = args.Value?.ToString();
        filters.Search = string.IsNullOrWhiteSpace(text) ? null : text;
        await TriggerFilterAsync();
    }

    private async Task OnSortFieldChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var value))
        {
            filters.SortBy = (RequestSortField)value;
            await TriggerFilterAsync();
        }
    }

    private async Task ToggleSortDirection()
    {
        filters.SortDirection = filters.SortDirection == SortDirection.Asc
            ? SortDirection.Desc
            : SortDirection.Asc;
        await TriggerFilterAsync();
    }

    private static string GetSortLabel(RequestSortField field) =>
        field switch
        {
            RequestSortField.Status => "Status",
            _ => "Date"
        };

    private static string? FormatDate(DateOnly? date) => date?.ToString("yyyy-MM-dd");

    private static DateOnly? ParseDate(string? raw) =>
        DateOnly.TryParse(raw, out var value) ? value : null;

    private Task ChangePage(int newPage)
    {
        if (newPage <= 0 || newPage == filters.Page)
        {
            return Task.CompletedTask;
        }

        return ReloadAsync(newPage);
    }

    private async Task ShowDetailsAsync(Guid requestId)
    {
        try
        {
            selectedRequest = await ApiClient.GetRequestForUserAsync(requestId);
            isHistoryModalOpen = selectedRequest is not null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Unable to load details: {ex.Message}";
            NotificationService.Error(errorMessage);
        }
    }

    private Task CloseHistoryModal()
    {
        isHistoryModalOpen = false;
        selectedRequest = null;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
